<link rel="stylesheet" href="css/chat.css" type="text/css" media="all" />
<script src="js/chat.js" charset="utf-8"></script>
<title>Meldinger</title>
<h1 class="grad">Meldinger</h1>

<div class="tabs">
  <button id="mychat" onclick='changeTab(1)'>Mine</button>
  <button onclick='changeTab(2)'>grupper</button>
  <button onclick='changeTab(3)'>Utforsk</button>
</div>

<div class="split">
  <div class="left">
    <div class="tab active">
    </div>
    <div class="tab">
      <a href='javascript:openChat(this)'>Bowlingkveld</a>
    </div>
    <div class="tab">
      <a href='javascript:openChat(this)'>Ponyclub</a>
      <a href='javascript:openChat(this)'>Fotball</a>
    </div>
  </div>
  <div class="right" id="chat-view">
    <div id="chat">
    </div>
    <div id="chat-input">
      <input type="text" placeholder='Skriv melding her' id="chatbox" /> <button>Send</button>
    </div>
  </div>
</div>

<script>
 window.addEventListener('load', loadChats)
 function loadChats () {
  getMyChats(chats => {
    for (c of chats) {
      addChat(c);
    }
  });

  document.querySelector("#chatbox").onkeypress
    = onChatBoxKeyDown;
 }
 function addChat (chat)
 {
  let chatElem = document.createElement('a')
  chatElem.innerText = "chat #" + chat.cid
  chatElem.href="javascript:onChatClicked(" + chat.cid + ")";
  document.querySelector(".split .tab:nth-child(1)").appendChild(chatElem)
 }

 function onChatClicked (cid) {
  window.activeChat = cid;
  postReadChat(cid, openChat);
 }

 function openChat (messages) {
  for (let msg of messages) {
    getUser(msg.sender, usr => {
      addChatMsgElem(usr.username, msg.content);
    });
  }
 }

 function addChatMsgElem (username, m) {
  const cont = document.querySelector('#chat');
  let el = document.createElement('div');
  el.classList.add("message");
  let msg = document.createElement('span');
  let usr = document.createElement('span');
  usr.innerText = username + ": ";
  msg.innerText = m;
  el.appendChild(usr);
  el.appendChild(msg);
  cont.appendChild(el);
 }

 setInterval(postChatRead(activeChat), 3000);

 function onChatBoxKeyDown (e) {
   if (window.activeChat === undefined) {
    return false
   }
   if (e.which !== 13) return;
   const msg = document.querySelector("#chatbox").value;
   if (msg.length === 0) return;

   postPutChat([activeChat, msg], _ => {
     document.querySelector("#chatbox").value = "";
     getWhoami(usr => {
       addChatMsgElem(usr.username, msg);
     });
   });
 }
</script>
