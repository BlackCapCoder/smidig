<link rel="stylesheet" href="css/chat.css" type="text/css" media="all" />
<script src="js/chat.js" charset="utf-8"></script>
<title>Meldinger</title>
<h1 class="grad">Meldinger</h1>

<div class="tabs">
  <button onclick='changeTab(1)'>Meldinger</button>
  <button onclick='changeTab(2)'>Gruppechat</button>
  <button onclick='changeTab(3)'>Utforsk</button>
</div>

<div class="split">
  <div class="left">
    <div class="tab active">
    </div>
    <div class="tab">
    </div>
    <div class="tab">
      <a href='javascript:openChat(this)'>Ponyclub</a>
      <a href='javascript:openChat(this)'>Fotball</a>
    </div>
  </div>
  <div class="right" id="chat-view">
    <div id="chat">
    </div>
    <div id="chat-input">
      <input type="text" placeholder='Skriv melding her' id="chatbox" /> <button>Send</button>
    </div>
  </div>
</div>

<script>
 window.addEventListener('load', loadChats)
 function loadChats () {
  getMyChats(chats => {
    for (c of chats) {
      addChat(c);
    }

    let h = window.location.hash.substr(1);
    if (h == "") return;
    h = Number(h);
    onChatClicked(h);
  });

  document.querySelector("#chatbox").onkeypress
    = onChatBoxKeyDown;
 }

/* function activeTab () {
  const a = document.querySelector('.tab.active');
  return Array.from(a.parentElement.children).indexOf(a)
 }*/

 function addChat (chat)
 {
  let chatElem = document.createElement('a')
  var tabNr = new activeTab();

//  console.log(tabNr);
  if(tabNr == 1)
    {
      chatElem.innerText = "Samtale #" + chat.cid;
 /* document.querySelector(".split .tab:nth-child(1)").appendChild(chatElem);
    }
  else if(tabNr == 2)
    {
      chatElem.innerText = "Gruppesamtale #" + chat.cid;
      
  document.querySelector(".split .tab:nth-child(1)").appendChild(chatElem);
    }*/
  chatElem.href="javascript:onChatClicked(" + chat.cid + ")";
  document.querySelector(".split .tab:nth-child(1)").appendChild(chatElem);
 }

 function onChatClicked (cid) {
  window.activeChat = cid;
  postReadChat(cid, openChat);
 }

 function openChat (messages) {
  for (let msg of messages) {
    idlastmessage = msg.mid
    getUser(msg.sender, usr => {
      addChatMsgElem(usr.username, msg.content);
    });
  }
 }

 function addChatMsgElem (username, m) {
  const cont = document.querySelector('#chat');
  let el = document.createElement('div');
  el.classList.add("message");
  let msg = document.createElement('span');
  let usr = document.createElement('span');
  usr.innerText = username + ": ";
  msg.innerText = m;
  el.appendChild(usr);
  el.appendChild(msg);
  cont.appendChild(el);
 }

 setInterval(_ => {
  console.log("hei");
    postReadChatSince([activeChat, idlastmessage], openChat)
 }, 3000);

 function onChatBoxKeyDown (e) {
   if (window.activeChat === undefined) {
    return false
   }
   if (e.which !== 13) return;
   const msg = document.querySelector("#chatbox").value;
   if (msg.length === 0) return;

   postPutChat([activeChat, msg], mid => {
     document.querySelector("#chatbox").value = "";
     getWhoami(usr => {
       idlastmessage = mid
       addChatMsgElem(usr.username, msg);
     });
   });
 }
</script>
