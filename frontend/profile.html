<link rel="stylesheet" href="css/bowling.css">

<script>
  uid  = window.location.hash.substr(1);
  isMe = undefined;

  window.onload = _ => {

    if (uid != "") {
      uid = Number(uid);

      getWhoami(u => {
        isMe = u.uid == uid;
        getUser (uid, onGotUser);
      });
    } else {
      isMe = true;
      getWhoami(u => {
        uid = u.uid;
        onGotUser(u);
      });
    }

    function onGotUser (u) {
      document.querySelector('#pic').setAttribute('src', u.pic);
      document.querySelector('#name').innerText = u.username;
      document.querySelector('#age').innerText = u.age;
      document.querySelector('#desc').innerText = u.desc;
      document.querySelector('#btnEdit').disabled = !isMe;

      checkOnline(u);
      checkFriendship();

      postListfriends(uid, fs => {
        for (let f of fs)
          getUser (f, usr => {
            addFriendElem (usr);
          });
      });
    }

    function checkOnline (usr) {
      if (isMe) {
        document.querySelector('#status').classList.add('hidden');
        return;
      }

      now  = new Date();
      then = new Date(usr.lastSeen);
      setOnlineStatus (now - then <= 15 * 60 * 1000);
    }


    function checkFriendship(){
      if (isMe) return setFriendButton (0);

      postFriendshipStatus(uid, s => {
        switch (s.tag) {
          case ("NotFriends"):
            setFriendButton (1);
            break;
          case ("Friends"):
            setFriendButton (0);
            break;
          case ("PendingAccept"):
            if (s.contents)
              setFriendButton(2);
            else
              setFriendButton(3);
            break;
        }
      });
    }
  };

  function setOnlineStatus (b) {
    const stEl = document.querySelector('#status');

    stEl.classList.remove('hidden');

    if (b) {
      stEl.classList.remove('offline');
      stEl.classList.add('online');
    } else {
      stEl.classList.remove('online');
      stEl.classList.add('offline');
    }
  }

  function changesPressed()
  {
    window.location = "changes";
  }

  // c/p from event.html
  function addFriendElem (u) {
    let cont = document.createElement('div')
      , lft  = document.createElement('a')
      , rgt  = document.createElement('div')
      , pic  = document.createElement('img')
      , name = document.createElement('span')
      , age  = document.createElement('span')
      ;

    cont.classList.add ('person');
    lft.classList.add  ('left');
    rgt.classList.add  ('right');
    pic.classList.add  ('profile');
    name.classList.add ('name');
    age.classList.add  ('age');

    cont.appendChild(lft);
    cont.appendChild(rgt);
    lft.appendChild(pic);
    rgt.appendChild(name);
    rgt.appendChild(age);

    pic.setAttribute('src', u.pic);
    name.innerText = u.username;
    age.innerText = u.age;

    lft.setAttribute('href', 'profile#' + u.uid);

    const party = document.querySelector("#friends");
    party.appendChild(cont);
  }

  function onBefriendClicked () {
    console.log(uid)
    postBefriend (uid, e => {
      alert ("Venneforespørsel er sendt")
    })
  }

  function setFriendButton (s) {
    const btn = document.querySelector('#befriend');

    if (s == 0) {
      btn.disabled = true;
      btn.value    = "Dere er venner"
    } else
    if (s == 1) {
      btn.disabled = false;
      btn.value    = "Legg til som venn"
    } else
    if (s == 2) {
      btn.disabled = false;
      btn.value    = "Aksepter venneforespørsel"
    } else
    if (s == 3) {
      btn.disabled = true;
      btn.value    = "Venneforespørsel er sendt"
    }
  }

  function onSendMessageClicked () {
    postChatWithUser (uid, cid => {
      window.location = "messages#" + cid;
    });
  }
  function onFindEventsClicked () {
    window.location = "events#user:" + uid;
  }
</script>

<title>Profil</title> <!-- persons name here -->

<body>
  <table>
    <tr>
      <td>
        <img id="pic"/>
        <div id="status" class="hidden"></div>
      </td>
      <td>
        <p id="name"></p>
        <p id="age"></p>
        <p id="desc"></p>
      </td>
    </tr>
  </table>
  </br>
  <p id="self_info">
    </p>
  <input type="button" onclick="onSendMessageClicked()" name="" id="" value="Send melding" />
  <input type="button" onclick="onFindEventsClicked()" name="" id="find-events" value="Finn arrangementer" />
  </br></br>
  <input type="button" onclick='onBefriendClicked()' name="" id="befriend" value="Legg til som venn" />
  </br></br>
  <input type="button" onClick="changesPressed()" name="" id="btnEdit" value="Gjør endringer" />

  <section id="friends">
  </section>
</body>

<style>
  td { position: relative; }
  #status {
    --rad: 14px;
    width: var(--rad);
    height: var(--rad);
    position: absolute;
    right: 0; bottom: 0;
    border-radius: 100%;
    margin: 4px;
  }
  #status.online {
    background: green;
    box-shadow: 0 0 5px 2px rgba(0,255,0,0.4);
  }
  #status.offline {
    background: red;
    box-shadow: 0 0 5px 2px rgba(255,0,0,0.4);
  }
  #pic { width: 300px; }
  #name
  {
  font-size: 30px; 
  }
  #age
  {
  font-size: 30px; 
  }
  #self-info
  {
    text-indent-left: 50px;
  }
</style>
