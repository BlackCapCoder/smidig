<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/bowling.css">

    <script>
      function addPart (u) {
        let cont = document.createElement('div')
          , lft  = document.createElement('a')
          , rgt  = document.createElement('div')
          , pic  = document.createElement('img')
          , name = document.createElement('span')
          , age  = document.createElement('span')
          ;

        cont.classList.add ('person');
        lft.classList.add  ('left');
        rgt.classList.add  ('right');
        pic.classList.add  ('profile');
        name.classList.add ('name');
        age.classList.add  ('age');

        cont.appendChild(lft);
        cont.appendChild(rgt);
        lft.appendChild(pic);
        rgt.appendChild(name);
        rgt.appendChild(age);

        pic.setAttribute('src', u.pic);
        name.innerText = u.username;
        age.innerText = u.age;

        lft.setAttribute('href', 'profile#' + u.uid);

        party.appendChild(cont);
      }

      window.onload = _ => {
        let hash = window.location.hash.substr (1);
        evid  = Number (hash);
        party = document.querySelector("#participants")

        getGetevent (evid, ev => {
          date = new Date (ev.date);

          document.title = ev.title;
          document.querySelector("#title").innerText   = ev.title;
          document.querySelector("#desc").innerText    = ev.desc;
          document.querySelector("#time").innerText    = date.toTimeString().split(' ')[0];
          document.querySelector("#date").innerText    = date.toLocaleDateString();
          document.querySelector("#place").innerText   = ev.place;

          getUser (ev.owner, u => {
            document.querySelector("#creator").innerText = u.username;
            // addPart (u);
          });
        });

        getPictures (evid, ps => {
          let cont = document.querySelector("#rad");

          for (let p of ps) {
            let el_div = document.createElement('div');
            let el_pic = document.createElement('img');

            el_div.classList.add('image');
            el_pic.setAttribute('src', p.pth);
            el_div.appendChild(el_pic);

            cont.appendChild(el_div);
          }
        });

        getParticipants (evid, ps => {
          for (let p of ps) {
            getUser (p.uid, u => {
              addPart (u);
            });
          }
        });

        function loadComments () {
          postEventcomments (evid, cs => {
            const cont = document.querySelector('#comment-section');

            for (let c of cs) {
              getUser(c.owner, u => {
                addCommentElem(u.username, c.content);
              });
            }
          });
        };

        loadComments ();
      }

      function joinEvent () {
        function succ () {
          alert("Du er nå satt opp på dette arrangementet, håper jeg ser deg der!")
        }
        function fail () {
          alert("Noe gikk galt, prøv igjen senere");
        }

        postJoinEvent (evid, succ, fail);
      }

      function addCommentElem (username, message) {
        const cont = document.querySelector('#comment-section');
        let el = document.createElement('div');
        el.classList.add("comment");
        let msg = document.createElement('span');
        let usr = document.createElement('span');
        usr.innerText = username + " said: ";
        msg.innerText = message;
        el.appendChild(usr);
        el.appendChild(msg);
        cont.appendChild(el);
      }

      function onCommentClicked () {
        const msg = document.querySelector("#comment-box").value;
        if (msg.length < 2) return alert ("A bit short if you ask me!");
        if (msg.length > 400) return alert ("Way too long!");
        postAddComment([evid, msg], _ => {
          getWhoami(who => {
            addCommentElem(who.username, msg);
          });
        });
      }
    </script>
  </head>

  <body>
    <img id="top-img" src="imgs/Banner1.png">

    <div id="info-wrapper">
      <div id="info">
        <h1 id='title'></h1>
        <table>
          <tr>
            <td><span>Laget av</span></td>
            <td><span id='creator'></span></td>
          </tr>
          <tr>
            <td><span>Tid</span></td>
            <td><span id='time'></span></td>
          </tr>
          <tr>
            <td><span>Sted</span></td>
            <td><span id='place'></span></td>
          </tr>
          <tr>
            <td><span>Dato</span></td>
            <td><span id='date'></span></td>
          </tr>
          <tr>
            <td><span>Kategori</span></td>
            <td><span id="tag"></td>
          </tr>
        </table>
      </div>
    </div>

    <div id="desc-wrapper">
      <span id='desc'></span>
    </div>

    <section id="button">
      <button type="button-1" onclick='joinEvent()'>Jeg kommer!</button>
      <!-- <button type="button&#45;2">Oversikt på deltakere</button> -->
      <button type="button-2" onclick='alert("Takk for at du viser interess, håper på å se deg der!")'>Interessert</button>
      <button type="button-3" onclick='alert("Lagt til i favoritter")'><img class="star-eve" src="imgs/favourit-star.png"/></button>
   </section>

    <div class="parti-wrapper">
      <h2>Skriv en kommentar</h2>
      <section id="participants">
      </section>
    </div>

    <section id="comment-section">
      <textarea id="comment-box" rows="8" cols="40" placeholder="Skriv din kommentar her"></textarea>
      </br>
      <button type="submit" onclick='onCommentClicked();'>Legg til kommentar</button>
    </section>

    <div id="row-wrapper">
      <div id="rad">
      </div>
    </div>

  </body>
</html>
